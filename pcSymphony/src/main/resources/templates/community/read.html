<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>게시물 상세보기</title>
    <script src="../../static/js/jquery-3.7.1.min.js" th:src="@{/js/jquery-3.7.1.min.js}"></script>
    <link href="../../static/css/style.css" rel="stylesheet" th:href="@{/css/style.css}">
    <link href="../../static/css/header.css" rel="stylesheet" th:href="@{/css/header.css}">
    <!--    <link href="../../static/css/read.css" rel="stylesheet" th:href="@{/css/read.css}">-->
    <script src="../../static/js/main.min.js" th:src="@{/js/main.min.js}"></script>
    <script src="../../static/js/header.js" th:src="@{/js/header.js}"></script>
    <script src="../../static/js/read.js" th:src="@{/js/read.js}"></script>

    <style>
        /* 게시판 컨테이너 스타일 */
        /*.community-container {*/
        /*    !*background-color: #f0f0f0; !* 약간 회색이 섞인 흰색 *!*!*/
        /*    !*border-radius: 8px;*!*/
        /*    padding: 40px;*/
        /*    width: 100%;*/
        /*    !*max-width: 900px;*!*/
        /*    !*box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);*!*/
        /*    word-wrap: break-word; !* 긴 단어도 줄바꿈 *!*/
        /*    word-break: break-word; !* 적절히 줄바꿈 *!*/
        /*    overflow-wrap: break-word; !* 최신 브라우저 호환 *!*/
        /*}*/

        #community-title {
            font-size: 32px;
            font-weight: bold;
            color: #000;
            margin-bottom: 10px;
        }
        .readHeader {
            margin: 16px 0 29px;
            padding-bottom: 11px;
            border-bottom: 1px solid #95A4B4;
            word-wrap: break-word; /* 긴 단어도 줄바꿈 */
            word-break: break-word; /* 적절히 줄바꿈 */
        }

        .community-content {
            font-size: 16px;
            color: #000;
            margin-bottom: 20px;
            min-height: 400px;
            white-space: pre-wrap;
            word-wrap: break-word; /* 긴 단어도 줄바꿈 */
            word-break: break-word; /* 적절히 줄바꿈 */
            overflow-wrap: break-word; /* 최신 브라우저 호환 */
            max-width: 900px;
        }

        #community-info {
            font-size: 14px;
            color: #333;
        }

        a {
            all: unset;
        }
        .button-footerContainer {
            display: flex; /* 플렉스 컨테이너 설정 */
            justify-content: space-between; /* 버튼 사이를 양 끝으로 배치 */
            align-items: center; /* 세로 방향 정렬 */
            gap: 10px; /* 버튼 간 간격 */
        }
    </style>
</head>
<body>
<!-- Header Fragment 포함 -->
<div th:replace="~{fragments/header :: headerFragment}"></div>
<div class="body-wrap ">
    <main class="site-content">
        <a class="titleName" href="/community/list"><h1 class="container-like">Community</h1></a>
        <div class="container">
            <div class="community-container">
                <!-- 에러 메시지 출력 (삭제 권한`이 없을 경우) -->
                <div class="error-message" th:if="${errorMessage != null}">
                    <p th:text="${errorMessage}"></p>
                </div>
                <div class="readHeader">
                    <!-- 게시물 제목 -->
                    <div id="community-title" th:text="${community.communityTitle}">제목</div>
                    <!-- 게시물 정보 -->
                    <div id="community-info">
                        작성자: <span th:text="${community.memberId}"></span>
                        조회수: <span th:text="${community.communityView}"></span>
                        작성일: <span th:text="${#temporals.format(community.communityDate, 'yyyy-MM-dd HH:mm')}"></span>
                    </div>
                </div>
                <!-- 게시물 내용 -->
                <div class="community-content" th:text="${community.communityContent}">내용</div>


                <!--    &lt;!&ndash; 수정/삭제 버튼 &ndash;&gt;-->
                <!--    <div class="edit-delete-buttons">-->
                <!--        &lt;!&ndash; 수정 버튼 &ndash;&gt;-->
                <!--        <a th:href="@{/community/update/{communityId}(communityId=${community.communityId})}" class="edit-button">수정</a>-->

                <!--        &lt;!&ndash; 삭제 버튼 &ndash;&gt;-->
                <!--        <form th:action="@{/community/delete}" method="POST">-->
                <!--            <input type="hidden" name="communityId" th:value="${community.communityId}" />-->
                <!--            <button type="submit" class="delete-button">삭제</button>-->
                <!--        </form>-->
                <!--    </div>-->

                <!-- 수정/삭제 버튼 -->
                <div class="button-container">
                    <!-- 수정 버튼 (작성자와 로그인한 사용자가 같을 때만 표시) -->
                    <button class="blue-button"><a
                               th:href="@{/community/update/{communityId}(communityId=${community.communityId})}"
                               th:if="${community.memberId == #authentication.name}">수정</a></button>

                    <!-- 삭제 버튼 (작성자와 로그인한 사용자가 같을 때만 표시) -->
                    <form method="POST" th:action="@{/community/delete}"
                          th:if="${community.memberId == #authentication.name}">
                        <input name="communityId" th:value="${community.communityId}" type="hidden"/>
                        <button class="gray-button" type="submit">삭제</button>
                    </form>
                </div>



                <!-- 리플 작성 폼 시작 -->
                <form id="replyForm">
                    <label for="communityReplyContent">리플입력</label>
                    <input id="communityReplyContent" name="replyContent" style="width:500px"/> <!-- 댓글 입력 필드 -->
                    <button id="replyWriteButton" type="button">저장</button>
                </form>

                <!-- 리플 목록 출력 시작 -->
                <table class="reply" id="replyTable">
                    <thead>
                    <tr>
                        <th>작성자</th>
                        <th>내용</th>
                        <th>삭제</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- 댓글 목록은 여기에 동적으로 추가됩니다. -->
                    </tbody>
                </table>
                <div class="button-footerContainer">
                <!-- 뒤로가기 버튼 -->
                <button class="white-button"><a href="/community/list">목록</a></button>
                <!--글쓰기 버튼-->
                <button class="blue-button"><a href="write">글쓰기</a></button>
                </div>
            </div>
        </div>
    </main>
</div>
</div>
<!--footer-->

<!--<input disabled id="communityId" th:value="${community.communityId}" type="text">-->
<!--<input disabled id="userId" th:value="${#authentication.name}" type="text">-->
<!--    // 현재 커뮤니티 ID와 사용자 ID를 얻어옵니다.-->
<!--    // communityId 값 가져오기-->
<!--    const communityId = document.getElementById('communityId').value;-->
<!--    console.log('Community ID:', communityId);-->

<!--    // userName 값 가져오기-->
<!--    const userId = document.getElementById('userName').value;-->
<!--    console.log('User Name:', userId);-->
<div th:replace="~{fragments/footer :: footerFragment}"></div>

</body>
<script>
    // communityId 값 가져오기
    const communityId = document.getElementById('communityId').value;

    // userName 값 가져오기
    const userId = document.getElementById('userId').value;


    // 현재 커뮤니티 ID와 사용자 ID를 얻어옵니다.
    console.log('Community ID:', communityId);
    console.log('User Id:', userId);

    // 댓글 목록을 로드하는 함수
    function loadComments() {
        $.ajax({
            url: '/community/communityReplyList?communityId=' + communityId, // GET 방식으로 파라미터 전달
            type: 'GET',
            success: function (data) {
                const replyTableBody = $('#replyTable tbody');
                replyTableBody.empty(); // 기존 댓글 목록을 비웁니다.

                // 서버에서 받은 댓글 데이터를 HTML로 출력
                data.forEach(function (comment) {
                    const commentHtml = `
                        <tr id="comment-${comment.communityReplyId}">
                            <td>${comment.memberId}</td>
                            <td>${comment.replyContent}</td>
                            <td>
                                <button onclick="deleteComment(${comment.communityReplyId})">삭제</button>
                            </td>
                        </tr>
                    `;
                    replyTableBody.append(commentHtml);
                });
            },
            error: function (xhr, status, error) {
                alert('댓글 목록 불러오기 실패');
            }
        });
    }

    // 댓글을 저장하는 함수
    $('#replyWriteButton').click(function () {
        const replyContent = $('#communityReplyContent').val();
        if (!replyContent) {
            alert('댓글을 입력하세요.');
            return;
        }

        const replyData = {
            communityId: communityId,
            memberId: userId,
            replyContent: replyContent
        };

        $.ajax({
            url: '/community/communityReplyWrite',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(replyData),
            success: function () {
                $('#communityReplyContent').val(''); // 댓글 입력란 초기화
                loadComments(); // 댓글 목록 새로고침
            },
            error: function () {
                alert('댓글 저장 실패!');
            }
        });
    });

    // 댓글을 삭제하는 함수
    function deleteComment(commentId) {
        const deleteData = {
            communityId: communityId,
            communityReplyId: commentId,
            memberId: userId
        };

        $.ajax({
            url: '/community/communityReplyDelete',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(deleteData),
            success: function () {
                loadComments(); // 댓글 목록 새로고침
            },
            error: function () {
                alert('댓글 삭제 실패!');
            }
        });
    }

    // 페이지 로드 시 댓글 목록 불러오기
    $(document).ready(function () {
        loadComments();
    });
</script>
</html>