<!DOCTYPE html>
<html class="no-js" lang="en"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:padding-top="http://www.w3.org/1999/xhtml" xmlns:padding-bottom="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width,initial-scale=1" name="viewport">
    <title>PcSymphony</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" href="../../static/css/style.css">
    <script th:src="@{/js/jquery-3.7.1.min.js}" src="../../static/js/jquery-3.7.1.min.js"></script>
</head>
<!--헤더-->
<body class="has-animations">
<div class="body-wrap">
    <header class="site-header invert-color">
        <div class="container">
            <div class="site-header-inner">
                <div class="brand">
                    <h1 class="m-0">
                        <a href="home.html">
                            <img th:src="@{/images/logo.svg}" src="../../static/images/logo.svg" alt="Tidy" width="32" height="32"></a></h1></div>
                <button id="header-nav-toggle" class="header-nav-toggle" aria-controls="primary-menu"
                        aria-expanded="false"><span class="screen-reader">Menu</span> <span class="hamburger"><span
                        class="hamburger-inner"></span></span></button>
                <nav id="header-nav" class="header-nav">
                    <div class="header-nav-inner">

                        <ul class="list-reset header-nav-right">

                            <li>
                                <!-- 로그인 전 -->
                                <th:block sec:authorize="not isAuthenticated()">
                                    <p><a class="button button-primary button-wide-mobile  button-sm"
                                          th:href="@{/member/login}">로그인</a></p>
                                    <p><a class="button button-primary button-wide-mobile  button-sm"
                                          th:href="@{/member/join}">회원가입</a></p>
                                </th:block>
                                <!-- 로그인 후 -->
                                <th:block sec:authorize="isAuthenticated()">
                                    <p><a class="button button-primary button-wide-mobile  button-sm"
                                          th:href="@{/member/logout}">로그아웃</a></p>
                                </th:block>
                            </li>
                        </ul>
                    </div>
                </nav>
            </div>
        </div>
    </header>
    <section class="hero section has-bg-color invert-color">
        <div class="container">
            <div class="hero-inner section-inner" >
                <div class="split-wrap">
                </div>
            </div>
        </div>
    </section>
    <!-- 에러 메시지 출력 (삭제 권한이 없을 경우) -->
    <div class="error-message" th:if="${errorMessage != null}">
        <p th:text="${errorMessage}"></p>
    </div>


    <!-- 게시물 제목 -->
    <div class="community-title" th:text="${community.communityTitle}"></div>

    <!-- 게시물 내용 -->
    <div class="community-content" th:text="${community.communityContent}"></div>

    <!-- 게시물 정보 -->
    <div class="community-info">
        조회수: <span th:text="${community.communityView}"></span> |
        작성자: <span th:text="${community.memberId}"></span> |
        작성일: <span th:text="${#temporals.format(community.communityDate, 'yyyy-MM-dd HH:mm')}"></span>
    </div>
    <!-- 수정/삭제 버튼 -->
    <div class="edit-delete-buttons">
        <!-- 수정 버튼 (작성자와 로그인한 사용자가 같을 때만 표시) -->
        <a class="edit-button"
           th:href="@{/community/update/{communityId}(communityId=${community.communityId})}" th:if="${community.memberId == #authentication.name}">수정</a>

        <!-- 삭제 버튼 (작성자와 로그인한 사용자가 같을 때만 표시) -->
        <form method="POST" th:action="@{/community/delete}" th:if="${community.memberId == #authentication.name}">
            <input name="communityId"    th:value="${community.communityId}" type="hidden"/>
            <button class="delete-button" type="submit">삭제</button>
        </form>
    </div>
    <!-- 뒤로가기 버튼 -->
    <a class="back-button" href="/community/list">목록으로 돌아가기</a>
</div>
<!-- 리플 작성 폼 시작 -->
<form id="replyForm">
    <label for="communityReplyContent">리플입력</label>
    <input id="communityReplyContent" name="replyContent" style="width:500px"/> <!-- 댓글 입력 필드 -->
    <button id="replyWriteButton" type="button">저장</button>
</form>

<!-- 리플 목록 출력 시작 -->
<table class="reply" id="replyTable">
    <thead>
    <tr>
        <th>작성자</th>
        <th>내용</th>
        <th>삭제</th>
    </tr>
    </thead>
    <tbody>
    <!-- 댓글 목록은 여기에 동적으로 추가됩니다. -->
    </tbody>
</table>
<script>
    // 현재 커뮤니티 ID와 사용자 ID를 얻어옵니다.
    const communityId = [[${community.communityId}]];  // 서버에서 동적으로 값을 받아옵니다.
    const userId = '[[${#authentication.name}]];' // 로그인한 사용자 ID를 서버에서 받아옵니다.

    // 댓글 목록을 로드하는 함수
    function loadComments() {
        $.ajax({
            url: '/community/communityReplyList?communityId=' + communityId, // GET 방식으로 파라미터 전달
            type: 'GET',
            success: function (data) {
                const replyTableBody = $('#replyTable tbody');
                replyTableBody.empty(); // 기존 댓글 목록을 비웁니다.

                // 서버에서 받은 댓글 데이터를 HTML로 출력
                data.forEach(function (comment) {
                    const commentHtml = `
                        <tr id="comment-${comment.communityReplyId}">
                            <td>${comment.memberId}</td>
                            <td>${comment.replyContent}</td>
                            <td>
                                <button onclick="deleteComment(${comment.communityReplyId})">삭제</button>
                            </td>
                        </tr>
                    `;
                    replyTableBody.append(commentHtml);
                });
            },
            error: function (xhr, status, error) {
                alert('댓글 목록 불러오기 실패');
            }
        });
    }

    // 댓글을 저장하는 함수
    $('#replyWriteButton').click(function () {
        const replyContent = $('#communityReplyContent').val();
        if (!replyContent) {
            alert('댓글을 입력하세요.');
            return;
        }

        const replyData = {
            communityId: communityId,
            memberId: userId,
            replyContent: replyContent
        };

        $.ajax({
            url: '/community/communityReplyWrite',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(replyData),
            success: function () {
                $('#communityReplyContent').val(''); // 댓글 입력란 초기화
                loadComments(); // 댓글 목록 새로고침
            },
            error: function () {
                alert('댓글 저장 실패!');
            }
        });
    });

    // 댓글을 삭제하는 함수
    function deleteComment(commentId) {
        const deleteData = {
            communityId: communityId,
            communityReplyId: commentId,
            memberId: userId
        };

        $.ajax({
            url: '/community/communityReplyDelete',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(deleteData),
            success: function () {
                loadComments(); // 댓글 목록 새로고침
            },
            error: function () {
                alert('댓글 삭제 실패!');
            }
        });
    }

    // 페이지 로드 시 댓글 목록 불러오기
    $(document).ready(function () {
        loadComments();
    });
</script>
<!--푸터-->
<footer class="site-footer center-content-mobile invert-color">
    <div class="container">
        <div class="site-footer-inner">
            <div class="footer-top space-between text-xxs">
                <div class="brand"><a th:href="@{/}">
                    <img alt="Tidy" height="32" src="/images/logo.svg"
                         width="32"></a></div>
                <div class="footer-social">
                    <ul class="list-reset">
                        <li><a href="#">
                            <svg height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg">
                                <title>Facebook</title>
                                <path d="M6.023 16L6 9H3V6h3V4c0-2.7 1.672-4 4.08-4 1.153 0 2.144.086 2.433.124v2.821h-1.67c-1.31 0-1.563.623-1.563 1.536V6H13l-1 3H9.28v7H6.023z"/>
                            </svg>
                        </a></li>
                        <li><a href="#">
                            <svg height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg">
                                <title>Twitter</title>
                                <path d="M16 3c-.6.3-1.2.4-1.9.5.7-.4 1.2-1 1.4-1.8-.6.4-1.3.6-2.1.8-.6-.6-1.5-1-2.4-1-1.7 0-3.2 1.5-3.2 3.3 0 .3 0 .5.1.7-2.7-.1-5.2-1.4-6.8-3.4-.3.5-.4 1-.4 1.7 0 1.1.6 2.1 1.5 2.7-.5 0-1-.2-1.5-.4C.7 7.7 1.8 9 3.3 9.3c-.3.1-.6.1-.9.1-.2 0-.4 0-.6-.1.4 1.3 1.6 2.3 3.1 2.3-1.1.9-2.5 1.4-4.1 1.4H0c1.5.9 3.2 1.5 5 1.5 6 0 9.3-5 9.3-9.3v-.4C15 4.3 15.6 3.7 16 3z"/>
                            </svg>
                        </a></li>
                        <li><a href="#">
                            <svg height="16" viewBox="0 0 16 16" width="16" xmlns="http://www.w3.org/2000/svg">
                                <title>Instagram</title>
                                <g>
                                    <circle cx="12.145" cy="3.892" r="1"/>
                                    <path d="M8 12c-2.206 0-4-1.794-4-4s1.794-4 4-4 4 1.794 4 4-1.794 4-4 4zm0-6c-1.103 0-2 .897-2 2s.897 2 2 2 2-.897 2-2-.897-2-2-2z"/>
                                    <path d="M12 16H4c-2.056 0-4-1.944-4-4V4c0-2.056 1.944-4 4-4h8c2.056 0 4 1.944 4 4v8c0 2.056-1.944 4-4 4zM4 2c-.935 0-2 1.065-2 2v8c0 .953 1.047 2 2 2h8c.935 0 2-1.065 2-2V4c0-.935-1.065-2-2-2H4z"/>
                                </g>
                            </svg>
                        </a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom space-between text-xxs invert-order-desktop">
                <nav class="footer-nav">
                    <ul class="list-reset">
                        <li><a href="#">Contact</a></li>
                        <li><a href="#">About us</a></li>
                        <li><a href="#">FAQ's</a></li>
                        <li><a href="#">Support</a></li>
                    </ul>
                </nav>
                <div class="footer-copyright">&copy; 2024 PcSymphony, all rights reserved</div>
            </div>
        </div>
    </div>
</footer>
<script th:src="@{/js/main.min.js}" src="../../static/js/main.min.js"></script>

</body>
</html>