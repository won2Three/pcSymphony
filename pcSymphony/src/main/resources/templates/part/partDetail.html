<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title th:text="${part.name} + ' 상세 정보'">Part Detail</title>
    <link href="../../static/css/style.css" rel="stylesheet" th:href="@{/css/style.css}">
    <link href="../../static/css/header.css" rel="stylesheet" th:href="@{/css/header.css}">
    <link href="../../static/css/partDetail.css" rel="stylesheet" th:href="@{/css/partDetail.css}">
    <script src="../../static/js/header.js" th:src="@{/js/header.js}"></script>
    <script src="../../static/js/partDetail.js" th:src="@{/js/partDetail.js}"></script>
    <style>
        .partsTitle {
            display: flex;
            align-items: center;
            gap: 10px;

        }
        .table-cell {
            padding: 8px 0;
            text-align: center;
            font-size: 14px;
        }
        th, td {

        }
    </style>
</head>
<body id="partDetail-body">
<!-- Header Fragment 포함 -->
<div th:replace="~{fragments/header :: headerFragment}"></div>
<div class="body-wrap">
    <main class="site-content">
        <a class="titleName" th:href="@{'/part/' + ${tableName}}"><h1 class="container-like">PartDetail</h1></a>

        <div class="container">
            <label class="partsTitle">
                <img alt="Part Image"
                     class="normal-image"
                     th:src="${part.imageUrl != null ? part.imageUrl : 'https://cdn-icons-png.flaticon.com/512/11327/11327239.png'}"/>
                <h2 th:text="${tableName} + ' : ' + ${part.name}">Part Detail</h2>
            </label>
            <table>

                <!-- 공통 속성들 -->
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Manufacturer</th>
                    <th>Price</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td th:text="${part.id}">ID</td>
                    <td th:text="${part.name}">Name</td>
                    <td th:text="${part.manufacturer}">Manufacturer</td>
                    <td th:text="${part.price}">Price</td>
                </tr>
                </tbody>
            </table>
            <table th:if="${tableName == 'cover'}">

                <!-- CoverDTO 속성들 -->
                <thead>
                <tr>
                    <th>Motherboard formfactor</th>
                    <th>Max Video Card Length</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td th:text="${part.coverMotherboardFormFactor}">Cover Motherboard Form Factor</td>
                    <td th:text="${part.coverMaxVideoCardLength}">Cover Max Video Card Length</td>
                </tr>
                </tbody>
            </table>
            <table th:if="${tableName == 'cpucooler'}">

                <!-- CpuCoolerDTO 속성들 -->
                <thead>
                <tr>
                    <th>CPUCooler Socket</th>
                    <th>CPUCooler height</th>

                </tr>
                </thead>
                <tbody>
                <tr>
                    <td th:text="${part.cpuCoolerMotherboardSockets}">CPU Motherboard Socket</td>
                    <td th:text="${part.cpuCoolerHeight}">CpuCooler Height</td>
                </tr>
                </tbody>
            </table>
            <table th:if="${tableName == 'cpu'}">

                <!-- CpuDTO 속성들 -->
                <thead>
                <tr>
                    <th>Socket</th>
                    <th>TDP</th>
                    <th>Core Count</th>
                    <th>Thread Count</th>
                    <th>Performance Core Clock</th>
                    <th>Performance Core Boost Clock</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td th:text="${part.cpuSocket}">Socket</td>
                    <td th:text="${part.cpuTdp}">TDP</td>
                    <td th:text="${part.cpuCoreCount}">Core Count</td>
                    <td th:text="${part.cpuThreadCount}">Thread Count</td>
                    <td th:text="${part.cpuPerformanceCoreClock}">Performance Core Clock</td>
                    <td th:text="${part.cpuPerformanceCoreBoostClock}">Performance Core Boost Clock</td>
                </tr>
                </tbody>
            </table>
            <table th:if="${tableName == 'memory'}">

                <!-- MemoryDTO 속성들 -->
                <thead>
                <tr>
                    <th>Memory Form Factor</th>
                    <th>Memory Module</th>
                    <th>Memory Speed</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td th:text="${part.memoryFormFactor}">Memory Form Factor</td>
                    <td th:text="${part.memorySize}">Memory Module</td>
                    <td th:text="${part.memorySpeed}">Memory Speed</td>
                </tr>
                </tbody>
            </table>
            <table th:if="${tableName == 'motherboard'}">

                <!-- MotherboardDTO 속성들 -->
                <thead>
                <tr>
                    <th>Socket CPU</th>
                    <th>Form Factor</th>
                    <th>Memory Type</th>
                    <th>Chipset</th>
                    <th>Memory Slot Count</th>
                    <th>M.2 Slot Count</th>
                    <th>Memory Max</th>

                </tr>
                </thead>
                <tbody>
                <tr>
                    <td th:text="${part.motherboardSocketCpu}">Motherboard Socket CPU</td>
                    <td th:text="${part.motherboardFormFactor}">Motherboard Form Factor</td>
                    <td th:text="${part.motherboardMemoryType}">Motherboard Memory Type</td>
                    <td th:text="${part.motherboardChipset}">Motherboard Chipset</td>
                    <td th:text="${part.motherboardMemorySlotCount}">Motherboard Memory Slot Count</td>
                    <td th:text="${part.motherboardMdot2SlotCount}">Motherboard M.2 Slot Count</td>
                    <td th:text="${part.motherboardMemoryMax}">Motherboard Memory Max</td>
                </tr>
                </tbody>
            </table>
            <table th:if="${tableName == 'powersupply'}">

                <!-- PowerSupplyDTO 속성들 -->
                <thead>
                <tr>
                    <th>Type</th>
                    <th>Wattage</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td th:text="${part.powerSupplyType}">Power Supply Type</td>
                    <td th:text="${part.powerSupplyWattage}">Power Supply Wattage</td>
                </tr>
                </tbody>
            </table>
            <table th:if="${tableName == 'storage'}">

                <!-- StorageDTO 속성들 -->
                <thead>
                <tr>
                    <th>Type</th>
                    <th>Form Factor</th>
                    <th>Capacity</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td th:text="${part.storageType}">Storage Type</td>
                    <td th:text="${part.storageFormFactor}">Storage Form Factor</td>
                    <td th:text="${part.storageCapacity}">Storage Capacity</td>
                </tr>
                </tbody>
            </table>
            <table th:if="${tableName == 'videocard'}">

                <!-- VideoCardDTO 속성들 -->
                <thead>
                <tr>
                    <th>Length</th>
                    <th>TDP</th>
                    <th>Memory</th>
                    <th>Chipset</th>
                    <th>Core Clock</th>
                    <th>Boost Clock</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td th:text="${part.videoCardLength}">Video Card Length</td>
                    <td th:text="${part.videoCardTdp}">Video Card TDP</td>
                    <td th:text="${part.videoCardMemory}">Video Card Memory</td>
                    <td th:text="${part.videoCardChipset}">Video Card Chipset</td>
                    <td th:text="${part.videoCardCoreClock}">Core Clock</td>
                    <td th:text="${part.videoCardBoostClock}">Boost Clock</td>
                </tr>
                </tbody>
            </table>
            <div class="button-container">
                <button class="blue-button" onclick="addToCart(this)" th:data-id="${part.id}"
                        th:data-table-name="${tableName}">
                    Add to cart
                </button>
            </div>
            <!-- 담기버튼을 누르면 tableName알맞는 장바구니의 id값에 담긴다. -->


            <!----------------------------------리뷰-------------------------------------------------->

            <!-- 리플 작성 폼 시작 -->
            <form class="reviewForm" id="reviewForm">
                <div class="inputWrapper">
                    <!--제목-->
                    <label class="replyLabel" for="partsReviewTitle">Title</label>
                    <textarea id="partsReviewTitle" name="partsReviewTitle" placeholder="Please enter the review title." required
                              type="text"></textarea>
                </div>
                    <!--내용-->
                <div class="inputWrapper">
                    <label class="replyLabel" for="partsReviewContent">Content</label>
                    <textarea id="partsReviewContent" name="partsReviewContent" placeholder="Please enter the review content."
                              required></textarea>
                    <!-- 댓글 입력 필드 -->
                </div>

                <!-- 각 부품의 ID는 URL에서 추출하여 자동으로 입력 -->
                <input id="cpuId" name="cpuId" type="hidden" value="">
                <input id="cpucoolerId" name="cpucoolerId" type="hidden" value="">
                <input id="motherboardId" name="motherboardId" type="hidden" value="">
                <input id="memoryId" name="memoryId" type="hidden" value="">
                <input id="storageId" name="storageId" type="hidden" value="">
                <input id="videocardId" name="videocardId" type="hidden" value="">
                <input id="powersupplyId" name="powersupplyId" type="hidden" value="">
                <input id="coverId" name="coverId" type="hidden" value="">

                <div class="starAndSave">
                    <label for="partsReviewRating">Rating :</label>
                    <select id="partsReviewRating" name="partsReviewRating" required>
                        <option value="1">1점</option>
                        <option value="2">2점</option>
                        <option value="3">3점</option>
                        <option value="4">4점</option>
                        <option value="5">5점</option>
                    </select>
                    <button class="blue-button" type="submit">Save</button>
                </div>
            </form>

            <script>
                // URL에서 부품 정보 추출
                document.addEventListener('DOMContentLoaded', function () {
                    const urlParts = window.location.pathname.split('/');
                    const partType = urlParts[1]; // 예: 'part'
                    const partCategory = urlParts[2]; // 예: 'cpu', 'motherboard', ...
                    const partDetailId = urlParts[3]; // 예: 부품 ID (예: 1)

                    // 각 부품에 해당하는 'hidden' input 필드를 자동으로 설정
                    if (partCategory === 'cpu') {
                        document.getElementById('cpuId').value = partDetailId;
                    } else if (partCategory === 'cpucooler') {
                        document.getElementById('cpucoolerId').value = partDetailId;
                    } else if (partCategory === 'motherboard') {
                        document.getElementById('motherboardId').value = partDetailId;
                    } else if (partCategory === 'memory') {
                        document.getElementById('memoryId').value = partDetailId;
                    } else if (partCategory === 'storage') {
                        document.getElementById('storageId').value = partDetailId;
                    } else if (partCategory === 'videocard') {
                        document.getElementById('videocardId').value = partDetailId;
                    } else if (partCategory === 'powersupply') {
                        document.getElementById('powersupplyId').value = partDetailId;
                    } else if (partCategory === 'cover') {
                        document.getElementById('coverId').value = partDetailId;
                    }
                });

                // 리뷰 작성 폼의 submit 이벤트 처리
                document.getElementById('reviewForm').addEventListener('submit', function (event) {
                    event.preventDefault(); // 폼 제출 기본 동작 방지

                    // 폼 데이터를 객체로 변환
                    const formData = {
                        partsReviewTitle: document.getElementById('partsReviewTitle').value,
                        partsReviewRating: document.getElementById('partsReviewRating').value,
                        partsReviewContent: document.getElementById('partsReviewContent').value,
                        cpuId: document.getElementById('cpuId').value || null,
                        cpucoolerId: document.getElementById('cpucoolerId').value || null,
                        motherboardId: document.getElementById('motherboardId').value || null,
                        memoryId: document.getElementById('memoryId').value || null,
                        storageId: document.getElementById('storageId').value || null,
                        videocardId: document.getElementById('videocardId').value || null,
                        powersupplyId: document.getElementById('powersupplyId').value || null,
                        coverId: document.getElementById('coverId').value || null
                    };

                    console.log(formData);  // 디버깅용: 폼 데이터가 제대로 들어오는지 확인

                    // POST 요청 보내기 (서버 API로)
                    fetch('/part/partsReviewWrite', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to save the review.');
                            }
                            return response.json(); // 응답을 JSON으로 처리
                        })
                        .then(data => {
                            // alert('The review was saved successfully.');
                            document.getElementById('reviewForm').reset(); // 폼 초기화

                            // 리뷰 목록을 새로 갱신
                            const pathParts = window.location.pathname.split('/');
                            const partType = pathParts[2];  // 예: 'cpu', 'memory' 등
                            const partId = parseInt(pathParts[3]);  // 1, 2, 3 등

                            // 리뷰 목록을 다시 가져와서 갱신
                            fetchReviews(partType, partId);
                        })
                        .catch(error => {
                            console.error('Error:', error);  // 오류를 로그로 출력
                            alert('Failed to save the review.');
                        });
                });

            </script>



            <!-- 리뷰 목록 -->
            <div class="review-list">
                <table>
                    <thead>
                    <tr>
                        <th style="width: 7%; text-align: center; padding: 8px 0">Author</th>
                        <th style="width: 15%; text-align: center; padding: 8px 0">Review Title</th>
                        <th style="width: 35%; text-align: center; padding: 8px 0">Review Content</th>
                        <th style="width: 10%; text-align: center; padding: 8px 0">Rating</th>
                        <th style="width: 15%; text-align: center; padding: 8px 0">Date Created</th>
                        <th style="width: 8%; text-align: center; padding: 8px 0">Edit</th>
                        <th style="width: 10%; text-align: center; padding: 8px 0">Delete</th>
                    </tr>
                    </thead>
                    <tbody id="review-list-body">
                    <!-- 실제 데이터로 채워질 부분 -->
                    </tbody>
                </table>
            </div>

            <script>
                // 페이지 로드 시, 리뷰 데이터를 불러오는 함수
                window.onload = function () {
                    // 현재 URL 경로에서 partType과 partId 추출
                    const pathParts = window.location.pathname.split('/');  // 경로를 '/'로 분리
                    const partType = pathParts[2];  // 'cpu', 'memory' 등
                    const partId = parseInt(pathParts[3]);  // 1, 2, 3 등

                    // review를 가져오는 함수 호출
                    fetchReviews(partType, partId);
                };

                // 리뷰 목록을 가져오는 함수
                function fetchReviews(partType, partId) {
                    // 서버에서 리뷰 데이터를 가져오는 GET 요청
                    fetch(`/part/${partType}/${partId}/reviews`)  // 수정된 API 엔드포인트로 요청
                        .then(response => response.json())  // JSON 형태로 응답 받기
                        .then(reviews => {
                            const tbody = document.getElementById('review-list-body');
                            tbody.innerHTML = '';  // 테이블 초기화
                            console.log(reviews);
                            reviews.forEach(review => {
                                // 리뷰 데이터를 기반으로 테이블 행을 동적으로 생성
                                const row = document.createElement('tr');
                                row.setAttribute('data-review-id', review.partsReviewId);  // data-review-id 속성 추가

                                // 작성자
                                const authorCell = document.createElement('td');
                                authorCell.textContent = review.memberId;  // 작성자 ID 표시, 나중에 이름으로 수정 가능
                                authorCell.classList.add('table-cell'); // CSS 클래스 추가
                                row.appendChild(authorCell);

                                // 리뷰 제목 (수정 가능하도록 input 추가)
                                const titleCell = document.createElement('td');
                                titleCell.innerHTML = `<span class="review-title">${review.partsReviewTitle}</span>
                                           <input class="edit-title" type="text" value="${review.partsReviewTitle}" style="display:none;" />`;
                                titleCell.classList.add('table-cell');
                                row.appendChild(titleCell);

                                // 리뷰 내용 (수정 가능하도록 만들기)
                                const contentCell = document.createElement('td');
                                contentCell.innerHTML = `<span class="review-content">${review.partsReviewContent}</span>
                                             <textarea class="edit-content" style="display:none;">${review.partsReviewContent}</textarea>`;
                                contentCell.classList.add('table-cell');
                                row.appendChild(contentCell);

                                // 별점 (수정 가능하도록 만들기)
                                const ratingCell = document.createElement('td');
                                ratingCell.innerHTML = `
                        <span class="review-rating">${review.partsReviewRating}</span>
                        <select class="edit-rating" style="display:none;">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    `;
                                ratingCell.classList.add('table-cell');
                                row.appendChild(ratingCell);

                                // 작성 날짜
                                // const dateCell = document.createElement('td');
                                // dateCell.textContent = new Date(review.partsReviewDate).toLocaleString();  // 날짜 포맷팅
                                // row.appendChild(dateCell);

                                // 작성 날짜
                                const dateCell = document.createElement('td');

                                // 날짜 포맷팅 (yyyy.mm.dd hh:mm)
                                const date = new Date(review.partsReviewDate);
                                const year = date.getFullYear();
                                const month = String(date.getMonth() + 1).padStart(2, '0');
                                const day = String(date.getDate()).padStart(2, '0');
                                const hours = String(date.getHours()).padStart(2, '0');
                                const minutes = String(date.getMinutes()).padStart(2, '0');
                                dateCell.textContent = `${year}.${month}.${day} ${hours}:${minutes}`; // 원하는 형식으로 설정
                                dateCell.classList.add('table-cell');
                                row.appendChild(dateCell);

                                // 수정 버튼 (작성자와 로그인한 사용자 비교 후 표시 여부 결정)
                                const editCell = document.createElement('td');
                                const editButton = document.createElement('button');
                                editButton.textContent = 'Edit';
                                // 클래스 추가
                                editCell.classList.add('table-cell');
                                editButton.classList.add('blue-button');

                                checkPermissionAndShowButton(review.partsReviewId, 'edit', editButton);  // 권한 확인 후 버튼 보이기
                                editCell.appendChild(editButton);
                                row.appendChild(editCell);

                                // 삭제 버튼 (작성자와 로그인한 사용자 비교 후 표시 여부 결정)
                                const deleteCell = document.createElement('td');
                                const deleteButton = document.createElement('button');
                                deleteButton.textContent = 'Delete';
                                // 클래스 추가
                                deleteCell.classList.add('table-cell');
                                deleteButton.classList.add('gray-button');
                                checkPermissionAndShowButton(review.partsReviewId, 'delete', deleteButton);  // 권한 확인 후 버튼 보이기
                                deleteCell.appendChild(deleteButton);
                                row.appendChild(deleteCell);

                                // 테이블에 행 추가
                                tbody.appendChild(row);
                            });
                        })
                        .catch(error => {
                            console.error('An error occurred while fetching the review list.:', error);
                        });
                }

                // 권한 확인 후 버튼을 보이거나 숨기기
                function checkPermissionAndShowButton(partsReviewId, action, button) {
                    fetch(`/part/partsReview/permission/${partsReviewId}?action=${action}`, {
                        method: 'GET',
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.isAllowed) {
                                // 권한이 있으면 버튼 클릭 이벤트 핸들러 추가
                                if (action === 'edit') {
                                    button.onclick = function () {
                                        editReview(partsReviewId);  // 권한이 있으면 수정
                                    };
                                } else if (action === 'delete') {
                                    button.onclick = function () {
                                        deleteReview(partsReviewId);  // 권한이 있으면 삭제
                                    };
                                }
                            } else {
                                // 권한이 없으면 버튼을 숨김
                                button.style.display = 'none';
                            }
                        })
                        .catch(error => {
                            console.error('An error occurred while checking permissions.:', error);
                            alert('A problem occurred while verifying permissions.');
                        });
                }

                // 수정 버튼 클릭 시 리뷰 수정
                function editReview(partsReviewId) {
                    const row = document.querySelector(`tr[data-review-id='${partsReviewId}']`);
                    const titleSpan = row.querySelector('.review-title');
                    const contentSpan = row.querySelector('.review-content');
                    const titleInput = row.querySelector('.edit-title');
                    const contentTextarea = row.querySelector('.edit-content');
                    const ratingSelect = row.querySelector('.edit-rating');
                    const ratingSpan = row.querySelector('.review-rating');  // 별점 span

                    // 현재 리뷰의 별점 값을 가져와서 select 태그의 기본값으로 설정
                    const currentRating = ratingSpan.textContent.trim();
                    ratingSelect.value = currentRating;

                    // 제목, 내용, 별점을 수정 가능하도록 전환
                    titleSpan.style.display = 'none';
                    contentSpan.style.display = 'none';
                    ratingSpan.style.display = 'none';
                    titleInput.style.display = 'inline-block';
                    contentTextarea.style.display = 'inline-block';
                    ratingSelect.style.display = 'inline-block';

                    // 수정 후 저장 버튼 추가
                    const editCell = row.querySelector('td:last-child'); // 마지막 수정 버튼 셀 찾기
                    let saveButton = editCell.querySelector('.save-button');
                    if (!saveButton) {
                        saveButton = document.createElement('button');
                        saveButton.textContent = 'Save';
                        saveButton.classList.add('save-button');
                        saveButton.classList.add('white-button');
                        saveButton.onclick = function () {
                            saveReview(partsReviewId, titleInput.value, contentTextarea.value, ratingSelect.value);
                        };
                        editCell.appendChild(saveButton); // 수정 버튼 셀에 저장 버튼 추가
                    }

                    // 저장 버튼만 보이게 함
                    saveButton.style.display = 'inline-block'; // 보이게 설정
                }

                // 리뷰 수정 후 저장
                function saveReview(partsReviewId, updatedTitle, updatedContent, updatedRating) {
                    const pathParts = window.location.pathname.split('/');
                    const partType = pathParts[2];  // 'cpu', 'memory' 등
                    const partId = parseInt(pathParts[3]);  // 1, 2, 3 등

                    fetch(`/part/partsReviewUpdate/${partsReviewId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            partsReviewTitle: updatedTitle,
                            partsReviewContent: updatedContent,
                            partsReviewRating: updatedRating,  // 수정된 별점도 함께 전송
                        }),
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`Error: ${response.status} - ${response.statusText}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            alert('The review has been updated.');
                            fetchReviews(partType, partId);  // 리뷰 목록 새로 고침
                        })
                        .catch(error => {
                            alert('Failed to update the review.');
                            console.error('Error:', error);  // 에러 로그 확인
                        });
                }

                // 리뷰 삭제 함수
                function deleteReview(partsReviewId) {
                    const confirmDelete = confirm('Are you sure you want to delete this review?');
                    if (confirmDelete) {
                        // 서버로 DELETE 요청 보내기
                        fetch(`/part/partsReviewDelete`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({partsReviewId: partsReviewId})
                        })
                            .then(response => {
                                if (response.ok) {
                                    alert('The review has been deleted.');
                                    window.location.reload(); // 페이지를 새로 고쳐서 리뷰 목록 업데이트
                                } else {
                                    alert('Failed to delete the review.');
                                }
                            })
                            .catch(error => {
                                console.error('An error occurred while deleting the review.:', error);
                                alert('Failed to delete the review.');
                            });
                    }
                }
            </script>
        </div>
    </main>
</div>
<!--푸터-->
<div th:replace="~{fragments/footer :: footerFragment}"></div>
</body>
</html>